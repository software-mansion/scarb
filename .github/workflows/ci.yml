name: CI

on:
  push:
    branches:
      - main
  pull_request:
  merge_group:

concurrency:
  group: ${{ github.head_ref || github.run_id }}
  cancel-in-progress: ${{ github.head_ref != 'main' }}
  
jobs:

  test-scarb-prove:
    name: test scarb-prove ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    env:
      # TODO(#1915): Use stable toolchain once stwo is stable.
      RUST_TOOLCHAIN: "nightly-2025-01-02"
      RUST_BACKTRACE: "full"
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: windows x86-64
            os: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
      - uses: Swatinem/rust-cache@v2
      - name: Build
        run: cargo +stable build --workspace --all-features --exclude scarb-prove
      - name: Run scarb-prove tests
        run: cargo +${{ env.RUST_TOOLCHAIN }} test -p scarb-prove

  check-rust-scarb-prove:
    name: check-rust (scarb-prove)
    runs-on: ubuntu-latest
    env:
      # TODO(#1915): Use stable toolchain once stwo is stable.
      RUST_TOOLCHAIN: "nightly-2025-01-02"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo +${{ env.RUST_TOOLCHAIN }} fmt --check -p scarb-prove
      - run: cargo +${{ env.RUST_TOOLCHAIN }} clippy --all-targets --all-features -p scarb-prove -- --no-deps
        env:
          # Make sure CI fails on all warnings, including Clippy lints.
          RUSTFLAGS: "-Dwarnings"
      - run: cargo +${{ env.RUST_TOOLCHAIN }} doc --all-features --no-deps -p scarb-prove
        env:
          # Make sure CI fails on all warnings, including Clippy lints.
          RUSTDOCFLAGS: "-Dwarnings"
